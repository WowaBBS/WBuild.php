<?  $Loader->Parent_Class('/Builder/Asset/Base');    class C_Builder_Asset_List extends C_Builder_Asset_Base  {    Var $List      =[]; // Array    Var $Removed   =[]; // Array // TODO: Can remove it, only for debug    Var $Public    =[]; // Array    Var $IsPrivate =true ; // TODO: Remove? It`s always true    Var $IsPublic  =false;    Protected Function _Init(Array $Args)    {      if(IsSet($Args['Outer']))      {        $Outer=$Args['Outer'];        $this->List     =$Outer->List     ;        $this->Public   =$Outer->Public   ;        $this->IsPublic =$Outer->IsPublic ;      }      Parent::_Init($Args);    }        Function _InitParam(Array &$Param)    {      parent::_InitParam($Param);      ForEach($Param As $k=>$v)      {        if(!Is_String($k))          $k=Array_Shift($v);        $this->CreateAsset($k, $v);      //UnSet($Param[$k]);      }      $Param=[];    }        Function IsInstance() { return false; }        Private Function _OnRemove($Asset)    {      if(Is_Null($Asset)) return;      $this->Removed[$Asset->Object_Id]=$Asset;    }        Private Static Function __Add(&$L, $KeyType, $K, $Asset)    {      $Res=null;      if(!IsSet($L[$KeyType]))        $L[$KeyType]=[];      $L=&$L[$KeyType];      if(IsSet($L[$K]))      {        $Res=$L[$K];        UnSet($L[$K]);        if($Res->Object_Id==$Asset->Object_Id)          $Res=null;      }      $L[$K]=$Asset;      return $Res;    }        Private Static Function __Remove(&$L, $KeyType, $K, $Asset)    {      if(!IsSet($L[$KeyType]))        return;      $L=&$L[$KeyType];      if(IsSet($L[$K]) && $L[$K]->Object_Id===$Asset->Object_Id)      {        UnSet($L[$K]);        return true;      }      return false;    }        Private Static Function __Exists(&$L, $KeyType, $K, $Asset)    {      if(!IsSet($L[$KeyType]))        return;      $L=&$L[$KeyType];      return IsSet($L[$K]) && $L[$K]->Object_Id===$Asset->Object_Id;    }        Function _Add(String $KeyType, C_Builder_Asset_Base $Asset)    {      $K=$Asset->GetKey();      if($Asset->ShouldBePrivate($this->IsPrivate))        $this->_OnRemove(Self::__Add($this->List, $KeyType, $K, $Asset));      if($Asset->ShouldBePublic($this->IsPublic))        Self::__Add($this->Public, $KeyType, $K, $Asset);    }        Function GetClass(String $Name)    {      return '/Builder/Asset/'.$Name;    }        Private Function _Create(Array &$Res, Array $Args=[])    {      $Info=$this->Get_Singleton($Args['Class' ]);      $List=$Info->_ParseParams($Args);      ForEach($List As $Item)      {        if(!IsSet($Item['Class']))          $Item['Class']=$this->GetClass($Item['Name']);        $Obj=$this->Create_Object($Item['Class'], $Item);        $this->_Add($Item['Name'], $Obj);        $Res[]=$Obj;      }    }        Function CheckCondition($Condition, $Args)    {      $Condition_Factory=$this->Get_Singleton('/Builder/Condition/Factory');      $Condition=$Condition_Factory->Create($Condition);      $z=$Condition->CheckAsset($this, $Args);      $Condition->Done();    //$Condition_Factory->Done();      return $z;    }          Function _CreateAsset(String $Name, $Param=[], Array $Args=[])    {      if(!Is_Array($Param))        $Param=[$Param];      if(IsSet($Param['>Sub']))      {        $Sub=$Param['>Sub'];        UnSet($Param['>Sub']);        Array_UnShift($Param, $Name);        $Sub[]=$Param;        $Param=$Sub;        $Name='Sub';       #$Deb=$this->Get_Singleton('/Debug/Manager')->Get('Asset_Sub.log');       #$Deb->Debug($Param);      }      $Class=$this->GetClass($Name);      $Args['Outer' ]=$this  ;      $Args['Class' ]=$Class ;      $Args['Name'  ]=$Name  ;      $Args['Param' ]=$Param ;      if(IsSet($Param['>If']))      {        if(!$this->CheckCondition($Param['>If'], $Args))          return null;        UnSet($Param['>If']);        $Args['Param' ]=$Param ;      }            if(IsSet($Param['>Debug']))      {        $Args['Debug']=$Param['>Debug'];        UnSet($Param['>Debug']);      }            $Res=[];      $this->_Create($Res, $Args);      switch(Count($Res))      {      case 0: return null;      case 1: return $Res[0];      default: return $Res;      }    }    Function _GetAssets($Name)    {      $A=$this->List;      return IsSet($A[$Name])? Array_Values($A[$Name]):[];    }        Function _RemoveAssets($Name)    {      $A=&$this->List;      if(!IsSet($A[$Name]))        return [];      $Res=$A[$Name];      UnSet($A[$Name]);      ForEach($Res As $K=>$Asset)      {        Self::__Remove($this->Public  ,$Name, $K, $Asset);        $this->_OnRemove($Asset);      }      return Array_Values($Res);    }        Function _ExistsAsset($KeyType, $Asset)    {      $Key=$Asset->GetKey();      return self::__Exists($this->List, $KeyType, $Key, $Asset);    }        Function _RemoveAsset($KeyType, $Asset)    {      $Key=$Asset->GetKey();      if(!self::__Remove($this->List, $KeyType, $Key, $Asset))        return false;      self::__Remove($this->Public, $KeyType, $Key, $Asset);      $this->_OnRemove($Asset);      return true;    }        Function RemoveAsset($Asset)    {      $Key=$Asset->GetKey();      ForEach($this->List As $k=>&$v)        if($this->_RemoveAsset($k, $Asset))          return;      Echo 'Asset not found for remove',"\n";    }    Function AddFrom($Asset, $bPublic=null, $bDebug=false)    {      if(Is_Null($bPublic))        $bPublic=$Asset->IsPublic;      $List=$bPublic? $Asset->Public:$Asset->List;      if($bDebug)      {        $Added=[];        ForEach($List As $KeyType=>$l)          ForEach($l As $K=>$v)            if(!$this->_ExistsAsset($KeyType, $v))              self::__Add($Added, $KeyType, $K, $v);                      ForEach($Added As $k=>$l)          $Added[$k]=Array_Values($l);        $Deb=$this->Get_Singleton('/Debug/Manager')->Get('Asset_AddFrom.log');      //if(!IsSet($Added['List']))      //$Deb->Debug($Added);        $Deb->Debug($List);      }      ForEach($List As $KeyType=>$l)        ForEach($l As $v)          if(!$this->_ExistsAsset($KeyType, $v))            $this->_Add($KeyType, $v);    }  //****************************************************************        Protected Function _Debug_Info(Array &$Res)    {      Parent::_Debug_Info($Res);      ForEach($Res['List'] As $k=>$v)        $Res['List'][$k]=Array_Values($v);    //ForEach($Res['Removed'] As $k=>$v)    //  $Res['Removed'][$k]=Array_Values($v);      ForEach($Res['Public'] As $k=>$v)        $Res['Public'][$k]=Array_Values($v);    }      //****************************************************************  };?>